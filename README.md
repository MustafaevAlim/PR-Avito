# Сервис назначения ревьюеров для Pull Request’ов

## API
Документация есть по пути `http://localhost/swagger`

## Запуск локально

1. **Создать .env**  
   Создать файл `.env` по `.env.example`
2. **Собрать приложение:**

        make build
3. **Запустить сервис:**

        make run
4. **Выполнить миграции базы(требуется утилита migrate):**

        make migrate-up
    Требуется уже запущенная бд.

## Запуск в Docker
1. **Создать .env**  
   Создать файл `.env` по `.env.example`
2. **Запустить сервисы:**

        sudo docker-compose up --build -d
    Миграции применяются в контейнере с помощью scripts/entrypoint.sh
## Тестирование

- Юнит-тесты:

        make test
- Линтер (golangci-lint):

        make lint

Для интеграционных тестов используется `testcontainers`, чтобы поднимать контейнер с тестовой БД прям из кода

## Миграции

- **Накатить все миграции:**  
`make migrate-up`
- **Откатить миграции:**  
`make migrate-down`
- **Текущая версия миграций:**  
`make migrate-version`
- **Принудительно установить версию:**  
`make migrate-force ver=0`



## Нагрузочное тестирование
### Общая информация
 - Длительность теста: 3 минуты 16 секунд
 - Общее количество итераций: 24,693
 - Успешность: 100% (0 ошибок из 24,713 запросов)​

 Использовался k6

### Подготовительный этап (Setup)
 Эндпоинт: POST /team/add

 Результат:
 - Создано 20 команд за 6 секунд
 - Добавлено 209 пользователей (100 защищенных + 109 для тестов)
 - 100% успешных запросов (20/20)
 - Среднее время отклика: ~300ms/команда

###  Этап 1: Управление пользователями (5с - 65с)
Эндпоинт: POST /users/setIsActive

Нагрузка: 20 виртуальных пользователей в течение 60 секунд

Метрики:
 - Checks passed: 100%​
 - Обработано пользователей: ~109 (деактивация/активация)
 - Среднее время отклика: 4.66ms
 - p95 latency: 9.39ms << 800ms 
 - Failures: 0%​


### Этап 2: Создание Pull Requests (70с - 190с)
Эндпоинт: POST /pullRequest/create

Нагрузка:  от 10 до 100 виртуальных пользователей (2 минуты)​

Метрики:

 - Success rate: 100% (использовались только активные пользователи)​
 - Создано PR: ~23,606 (расчет: 24,693 итераций - 1,087 Stage1)
 - Среднее время отклика: 4.66ms
 - p90 latency: 7.38ms
 - p95 latency: 9.39ms << 800ms
 - Max latency: 22.64ms
 - Failures: 0.00% 


## Структура
```
PR
├── api - API документация
├── cmd - точка входа приложения
├── internal
│   ├── api
│   │   └── handlers/ - слой обработчиков
│   ├── app
│   │   ├── app.go - приложение
│   │   └── service_provider.go - di-контейнер
│   ├── client
│   │   └── db/ - клиент для работы с бд
│   ├── closer/ - структура для корректного закрытия соединений и т.п.
│   ├── config/ - получение конфигов из .env
│   ├── mocks/ - моки, сгенерированные mockery
│   ├── model/ - модели сервисного слоя и принятия данных
│   ├── repository/ - слой репозиториев 
│   └── service/ - сервисный слой
├── scripts
│   ├── entrypoint.sh - скрипт для накатывания миграций в контейнере
│   └── tests
│       └── load_test.js - скрипт нагрузочного тестирования
├── migrations/ - миграции БД
├── Makefile
├── README.md
├── .golangci-lint.yml
├── .mockery.yaml
├── docker-compose.yaml
├── Dockerfile.backend
├── go.mod
└── go.sum
```
## Особенности
Для удобства тестирования принимаю в слое обработчиков строку в качестве id, если это корректный uuid, то он просто парсится, иначе генерируется uuid из строки